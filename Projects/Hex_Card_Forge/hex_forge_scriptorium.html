<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hex Card Forge - GUI Prototype</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4A0072; /* Rich Byzantine Purple */
            --primary-dark: #3A005A;
            --primary-light: #5C4077; /* Dark Lavender */
            --secondary: #DAA520; /* Goldenrod */
            --secondary-dark: #B8860B;
            --secondary-light: #F0C14C; /* Lighter gold for highlights if needed */
            --background: #1A1A2E; /* Dark Imperial Blue */
            --bg-content: #252538; /* Darker content area */
            --bg-content-light: #2C2C44; /* Slightly lighter content area */
            --text-light: #E0E0E0; /* Light Gray/Off-white */
            --text-medium: #B0B0B0; /* Medium Gray */
            --text-dark-contrast: #1A1A2E; /* For text on gold buttons */
            --border: #404058;
            --border-focus: var(--secondary);
            --text-error: #F87171; /* Tailwind red-400 for errors */
            --focus-outline-width: 2px;
            --focus-outline-offset: 1px;
            --focus-glow-color: rgba(218, 165, 32, 0.4);
            --spacing-unit: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden; 
        }

        .hidden-visually {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 calc(var(--spacing-unit) * 2.5); 
        }

        .screen {
            display: none; 
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            min-height: 100vh; 
            width: 100%;
            position: absolute; 
            top: 0;
            left: 0;
            padding-top: 70px; /* Adjusted for header height + a bit of space */
        }

        .screen.active {
            display: block; 
            opacity: 1;
            z-index: 1; 
        }
        
        *:focus-visible {
            outline: var(--focus-outline-width) solid var(--border-focus) !important;
            outline-offset: var(--focus-outline-offset) !important;
            box-shadow: 0 0 0 calc(var(--focus-outline-width) + 2px) var(--focus-glow-color) !important;
        }

        .btn {
            background-color: var(--primary);
            color: var(--text-light);
            border: none;
            padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 2); 
            border-radius: calc(var(--spacing-unit) * 0.5); 
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            min-width: 44px;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }
        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary { /* Goldenrod for Save */
            background-color: var(--secondary);
            color: var(--text-dark-contrast); 
        }
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-neutral { /* For Cancel/Export or less prominent actions */
             background-color: var(--bg-content-light);
             color: var(--text-light);
             border: 1px solid var(--border);
        }
        .btn-neutral:hover {
            background-color: var(--border);
        }

        .btn-danger {
            background-color: #991B1B; 
        }
        .btn-danger:hover {
             background-color: #7F1D1D; 
        }
        .btn--icon {
            padding: var(--spacing-unit);
        }

        .hex-card-shape { 
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }

        header {
            background-color: var(--primary);
            padding: calc(var(--spacing-unit) * 1.5) 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100; 
            min-height: 60px; /* Ensure header has a minimum height */
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem; 
            font-weight: 700;
            color: var(--text-light);
        }

        .logo span {
            color: var(--secondary);
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav li {
            margin-left: calc(var(--spacing-unit) * 2.5); 
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s, border-color 0.2s;
            padding: var(--spacing-unit) 0;
            border-bottom: 2px solid transparent;
        }

        nav a:hover, nav a.active-nav-link {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        #gateway {
            background-color: var(--background);
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: calc(var(--spacing-unit) * 5) 0; 
            text-align: center;
        }

        .hex-bg { 
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; 
            opacity: 0.05; 
            background-image:
                radial-gradient(var(--primary-light) 1px, transparent 1px),
                radial-gradient(var(--primary-light) 1px, transparent 1px);
            background-size: 60px 60px, 60px 60px; 
            background-position: 0 0, 30px 30px; 
            animation: pulseBg 20s infinite linear;
        }
        @keyframes pulseBg {
            0% { opacity: 0.03; transform: scale(1); }
            50% { opacity: 0.07; transform: scale(1.05); }
            100% { opacity: 0.03; transform: scale(1); }
        }

        .title-section { 
            margin-bottom: calc(var(--spacing-unit) * 7.5); 
            text-align: center;
            transform: translateY(-30px);
            opacity: 0;
            animation: fade-in-up 0.8s 0.2s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative; 
            z-index: 2;
        }

        @keyframes fade-in-up {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .title-section h1 {
            font-size: clamp(2.5rem, 6vw, 4rem); 
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--text-light);
        }

        .title-section span { color: var(--secondary); }
        .title-section p {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--text-medium);
            margin-top: var(--spacing-unit);
        }

        .hex-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: calc(var(--spacing-unit) * 3); 
            width: 100%;
            max-width: 1100px;
            padding: 0 calc(var(--spacing-unit) * 2.5); 
            position: relative; 
            z-index: 2;
        }

        .menu-option {
            background-color: var(--primary);
            width: 100%; 
            aspect-ratio: 1 / 1.15; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: calc(var(--spacing-unit) * 2); 
            color: var(--text-light);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            animation: scale-in 0.4s forwards cubic-bezier(0.34, 1.56, 0.64, 1);
            animation-delay: calc(var(--i) * 0.08s + 0.5s); 
            border: 2px solid transparent;
            transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
        }
        .menu-option:hover, .menu-option:focus-visible {
            background-color: var(--primary-light);
            transform: scale(1.05) !important; 
            border-color: var(--secondary);
        }

        @keyframes scale-in {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .menu-option i.fas { 
            font-size: 2rem; 
            margin-bottom: var(--spacing-unit); 
            color: var(--secondary);
            transition: transform 0.2s;
        }
        .menu-option:hover i.fas {
            transform: scale(1.1);
        }

        .menu-option h3 {
            margin-bottom: calc(var(--spacing-unit) * 0.75); 
            font-weight: 600;
            font-size: 1.1rem; 
        }

        .menu-option p {
            font-size: 0.85rem; 
            color: var(--text-medium);
            line-height: 1.4;
        }

        .content-screen-padding { 
             padding: calc(var(--spacing-unit) * 2.5) calc(var(--spacing-unit) * 1.25); 
        }
        @media (min-width: 768px) {
            .content-screen-padding {
                 padding: calc(var(--spacing-unit) * 5) calc(var(--spacing-unit) * 2.5); 
            }
        }
        
        /* Section Titles (Form & Preview in Scriptorium) */
        .section-title {
            color: var(--secondary);
            margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */
            border-bottom: 2px solid var(--primary);
            padding-bottom: var(--spacing-unit); /* 8px */
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
        }
        
        .form-section form, .pack-form {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 2.5); 
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit); 
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-medium);
        }

        .form-control {
            padding: calc(var(--spacing-unit) * 1.25); 
            background-color: var(--bg-content-light);
            border: 1px solid var(--border);
            border-radius: calc(var(--spacing-unit) * 0.5); 
            color: var(--text-light);
            width: 100%;
            min-height: 44px;
        }
        .form-control.input-error { /* For validation */
            border-color: var(--text-error);
            box-shadow: 0 0 0 1px var(--text-error);
        }
        .error-message-text {
            color: var(--text-error);
            font-size: 0.8rem;
            margin-top: calc(var(--spacing-unit) * 0.5);
        }


        #scriptorium .container, #visage-shaper .container, #collection-forge .container {
            padding-top: calc(var(--spacing-unit) * 2.5); 
            padding-bottom: calc(var(--spacing-unit) * 2.5); 
        }

        .scriptorium-container, .visage-container, .forge-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: calc(var(--spacing-unit) * 3.75); 
            background-color: var(--bg-content);
            padding: calc(var(--spacing-unit) * 2.5); /* Reduced padding for content area */
            border-radius: var(--spacing-unit); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        @media (min-width: 992px) { 
            .scriptorium-container, .visage-container {
                grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* Equal columns for more space */
            }
            .forge-container {
                 grid-template-columns: 2fr 1fr; 
            }
        }
        
        .metadata-list {
            margin-top: calc(var(--spacing-unit) * 2.5); 
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit); 
        }

        .metadata-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--spacing-unit); 
            align-items: center;
        }

        .add-metadata-btn-container { 
            display: flex;
            justify-content: flex-end;
            margin-top: var(--spacing-unit); 
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: calc(var(--spacing-unit) * 1.25); /* Add some top padding */
        }

        .card-preview-wrapper { 
            width: 100%;
            max-width: 300px; 
            aspect-ratio: 1 / 1.15; 
            margin-bottom: calc(var(--spacing-unit) * 2.5); /* Reduced margin */
            position: relative;
        }
        
        .card-preview-display { 
            width: 100%;
            height: 100%;
            background-color: var(--bg-content-light);
            border: 3px solid var(--secondary); /* Golden border */
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            align-items: center;
            padding: calc(var(--spacing-unit) * 1.5); /* Reduced padding */
            overflow: hidden; 
            text-align: center;
        }

        .card-image-preview { 
            width: 100%; /* Take full width within padding */
            flex-grow: 1; 
            max-height: 55%; /* Adjusted max height */
            background-color: var(--bg-content);
            margin-bottom: var(--spacing-unit); 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: calc(var(--spacing-unit) * 0.5); 
            /* Apply hex clip-path if image itself should be hex */
            /* clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); */
        }

        .card-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }
        .card-image-preview--empty {
            color: var(--text-medium);
            font-style: italic;
            font-size: 0.9rem;
        }


        .card-title-preview { 
            font-size: 1.2rem; /* Increased size */
            font-weight: 700;
            margin-bottom: calc(var(--spacing-unit) * 0.75); /* Reduced margin */
            color: var(--secondary);
            word-break: break-word;
            padding: 0 calc(var(--spacing-unit) * 0.5);
        }

        .card-metadata-preview { 
            width: 100%;
            font-size: 0.8rem; /* Slightly smaller for more items */
            color: var(--text-medium);
            max-height: 70px; 
            overflow-y: auto;
            padding: 0 calc(var(--spacing-unit) * 0.5);
        }

        .card-metadata-item-preview { 
            display: flex;
            justify-content: space-between;
            padding: calc(var(--spacing-unit) * 0.25) 0; /* Reduced padding */
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem; /* Smaller font for metadata items */
        }
        .card-metadata-item-preview:last-child {
            border-bottom: none;
        }
        .card-metadata-item-preview span:first-child { font-weight: 600; color: var(--text-light); margin-right: var(--spacing-unit); }


        .action-buttons {
            margin-top: calc(var(--spacing-unit) * 2.5); 
            display: flex;
            gap: var(--spacing-unit); 
            justify-content: flex-start; /* Aligned to start of form panel */
            flex-wrap: wrap; 
        }
        /* Ensure action buttons are at the bottom of the form panel */
        .form-section {
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes buttons to bottom if form is short */
        }


        /* Visage Shaper Screen */
        .cropping-area, .result-preview-container { 
            width: 100%;
            aspect-ratio: 4 / 3; 
            max-height: 400px; 
            background-color: var(--bg-content-light);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px dashed var(--border);
            overflow: hidden; 
        }
        .cropping-area img, .result-preview-container img {
            max-width: 100%;
            max-height: 100%;
            display: block; 
            user-select: none; 
        }

        .crop-overlay { 
            position: absolute;
            width: 60%; 
            aspect-ratio: 1 / 1.15; 
            max-width: 90%; 
            max-height: 90%;
            background-color: rgba(74, 0, 114, 0.3); 
            border: 2px solid var(--secondary);
            cursor: move;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); 
        }

        .cropping-controls {
            margin-top: calc(var(--spacing-unit) * 2.5); 
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit) * 1.5;
        }

        .control-group {
            margin-bottom: calc(var(--spacing-unit) * 1.5); 
        }

        .control-group label {
            display: block;
            margin-bottom: var(--spacing-unit); 
            color: var(--text-medium);
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--secondary); 
        }
        .result-preview-container {
            border-style: solid;
            border-color: var(--primary);
        }


        /* Obsidian Library Screen */
        .library-layout {
            display: flex; 
            flex-direction: column; 
            min-height: calc(100vh - 60px - (var(--spacing-unit) * 5)); 
        }
        @media (min-width: 768px) {
            .library-layout {
                flex-direction: row; 
            }
        }


        .sidebar {
            background-color: var(--primary);
            padding: calc(var(--spacing-unit) * 2.5); 
            width: 100%; 
            flex-shrink: 0; 
        }
        @media (min-width: 768px) {
            .sidebar {
                width: 240px; 
                height: auto; 
            }
        }


        .sidebar h2 {
            color: var(--secondary);
            margin-bottom: calc(var(--spacing-unit) * 2.5); 
            padding-bottom: var(--spacing-unit); 
            border-bottom: 1px solid var(--secondary-light);
            font-size: 1.5rem;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: var(--spacing-unit); 
        }

        .sidebar-menu a {
            color: var(--text-light);
            text-decoration: none;
            display: block;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.25); 
            border-radius: calc(var(--spacing-unit) * 0.5); 
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active-sidebar-link {
            background-color: var(--primary-light);
            color: var(--secondary);
        }

        .sidebar-menu a.active-sidebar-link {
            border-left: 3px solid var(--secondary);
            font-weight: 600;
        }

        .library-content {
            padding: calc(var(--spacing-unit) * 2.5); 
            flex-grow: 1; 
            background-color: var(--bg-content);
        }
        .library-content h2 { /* Ensure consistent section title styling */
             color: var(--secondary);
            margin-bottom: calc(var(--spacing-unit) * 2.5); /* 20px */
            border-bottom: 2px solid var(--primary);
            padding-bottom: var(--spacing-unit); /* 8px */
            font-size: 1.75rem; /* 28px */
        }


        .toolbar {
            display: flex;
            flex-direction: column; 
            gap: var(--spacing-unit) * 1.5; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--spacing-unit) * 2.5); 
            padding: var(--spacing-unit) * 1.5; 
            background-color: var(--bg-content-light);
            border-radius: calc(var(--spacing-unit) * 0.5); 
        }
         @media (min-width: 768px) {
            .toolbar {
                flex-direction: row; 
            }
        }


        .search-bar {
            display: flex;
            width: 100%;
            max-width: 400px; 
        }

        .search-bar input {
            padding: var(--spacing-unit); 
            border: 1px solid var(--border);
            background-color: var(--bg-content);
            color: var(--text-light);
            border-radius: calc(var(--spacing-unit) * 0.5) 0 0 calc(var(--spacing-unit) * 0.5); 
            flex-grow: 1;
            min-height: 44px;
        }

        .search-bar button {
            background-color: var(--primary);
            color: var(--text-light);
            border: none;
            border-radius: 0 calc(var(--spacing-unit) * 0.5) calc(var(--spacing-unit) * 0.5) 0; 
            padding: 0 calc(var(--spacing-unit) * 1.5); 
            cursor: pointer;
            min-height: 44px;
        }
        .search-bar button:hover { background-color: var(--primary-dark); }


        .filter-options {
            display: flex;
            gap: var(--spacing-unit); 
            flex-wrap: wrap; 
        }
        .filter-options .btn {
            padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit); 
            font-size: 0.85rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: calc(var(--spacing-unit) * 2.5); 
        }

        .card-item { 
            background-color: var(--bg-content-light);
            aspect-ratio: 1 / 1.15; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; 
            padding: var(--spacing-unit); 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
            overflow: hidden; 
        }

        .card-item:hover, .card-item:focus-visible {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--secondary-light);
            border-color: var(--secondary);
        }

        .card-thumbnail { 
            width: 90%;
            height: 65%; 
            background-color: var(--bg-content);
            border: 1px solid var(--primary);
            margin-bottom: var(--spacing-unit); 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-info {
            text-align: center;
            width: 100%;
            padding: 0 calc(var(--spacing-unit) * 0.5); 
        }

        .card-info h4 {
            font-size: 0.9rem; 
            margin-bottom: calc(var(--spacing-unit) * 0.5); 
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-info p {
            font-size: 0.75rem; 
            color: var(--text-medium);
        }

        /* Collection Forge Screen */
        .card-selection h2, .pack-details h2 { /* Re-applying section title style */
            color: var(--secondary);
            margin-bottom: calc(var(--spacing-unit) * 2); 
            border-bottom: 2px solid var(--primary);
            padding-bottom: var(--spacing-unit); 
            font-size: 1.5rem; 
        }


        .card-list {
            height: 500px;
            overflow-y: auto;
            background-color: var(--bg-content-light);
            padding: calc(var(--spacing-unit) * 1.5); 
            border-radius: calc(var(--spacing-unit) * 0.5); 
            border: 1px solid var(--border);
        }

        .card-list-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-unit); 
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .card-list-item:last-child { border-bottom: none; }
        .card-list-item:hover { background-color: var(--primary-light); }


        .list-thumbnail { 
            width: 60px;
            height: 69px; 
            background-color: var(--bg-content);
            margin-right: calc(var(--spacing-unit) * 1.5); 
            border: 1px solid var(--primary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .list-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .list-item-info {
            flex-grow: 1;
        }

        .list-item-info h4 {
            font-size: 0.9rem; 
            margin-bottom: calc(var(--spacing-unit) * 0.5); 
            color: var(--text-light);
        }

        .list-item-info p {
            font-size: 0.8rem; 
            color: var(--text-medium);
        }

        .list-checkbox {
            margin-left: var(--spacing-unit); 
            transform: scale(1.2); 
            accent-color: var(--secondary);
        }

        .pack-details {
            display: flex;
            flex-direction: column;
        }
        .pack-preview { 
            width: 100%;
            max-width: 200px;
            aspect-ratio: 1;
            background-color: var(--bg-content-light);
            border: 1px dashed var(--border);
            border-radius: calc(var(--spacing-unit) * 0.5); 
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-medium);
            margin-top: var(--spacing-unit); 
        }


    </style>
</head>
<body>
    <header role="banner">
        <div class="container">
            <div class="logo">
                <h1>HEX <span>CARD</span> FORGE</h1>
            </div>
            <nav role="navigation" aria-label="Main Navigation">
                <ul>
                    <li><a href="#gateway" class="nav-link" data-screen="gateway">Gateway</a></li>
                    <li><a href="#obsidian-library" class="nav-link" data-screen="obsidian-library">Library</a></li>
                    <li><a href="#scriptorium" class="nav-link active-nav-link" data-screen="scriptorium">Scriptorium</a></li>
                    <li><a href="#visage-shaper" class="nav-link" data-screen="visage-shaper">Visage Shaper</a></li>
                    <li><a href="#collection-forge" class="nav-link" data-screen="collection-forge">Collection Forge</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main role="main">
        <section id="gateway" class="screen">
            <div class="hex-bg"></div>
            <div class="title-section">
                <h1>HEX <span>CARD</span> FORGE</h1>
                <p>Craft Your Legend, One Hex at a Time</p>
            </div>
            <div class="hex-menu container">
                <a href="#" class="menu-option hex-card-shape" style="--i:1;" data-screen-link="scriptorium" aria-label="Create New Card">
                    <i class="fas fa-magic"></i> <h3>Create New Card</h3>
                    <p>Begin a new artifact of power.</p>
                </a>
                <a href="#" class="menu-option hex-card-shape" style="--i:2;" data-screen-link="obsidian-library" aria-label="Open Card Library">
                    <i class="fas fa-book-open"></i>
                    <h3>Card Library</h3>
                    <p>Browse your collection of relics.</p>
                </a>
                <a href="#" class="menu-option hex-card-shape" style="--i:3;" data-screen-link="collection-forge" aria-label="Create Booster Pack">
                    <i class="fas fa-box-open"></i>
                    <h3>Booster Packs</h3>
                    <p>Assemble collections of might.</p>
                </a>
                <a href="#" class="menu-option hex-card-shape" style="--i:4;" data-screen-link="scriptorium" aria-label="Design Card Template">
                    <i class="fas fa-drafting-compass"></i>
                    <h3>Design Template</h3>
                    <p>Shape card layouts and defaults.</p>
                </a>
                <a href="#" class="menu-option hex-card-shape" style="--i:5;" data-screen-link="visage-shaper" aria-label="Image Tools">
                    <i class="fas fa-crop-alt"></i>
                    <h3>Image Tools</h3>
                    <p>Refine visages for your cards.</p>
                </a>
            </div>
        </section>

        <section id="scriptorium" class="screen active content-screen-padding">
            <div class="container">
                <div class="scriptorium-container">
                    <div class="form-section">
                        <h2 class="section-title">Card Creation Form</h2>
                        <form id="cardForm">
                            <div class="form-group">
                                <label for="cardTitle">Card Title</label>
                                <input type="text" id="cardTitle" class="form-control" placeholder="e.g., Arcane Hexstone" value="Arcane Hexstone" required aria-describedby="cardTitleError">
                                <p id="cardTitleError" class="error-message-text" aria-live="assertive"></p>
                            </div>
                            <div class="form-group">
                                <label for="cardImageUpload">Card Image</label>
                                <input type="file" id="cardImageUpload" class="form-control" accept="image/*" aria-describedby="cardImageError">
                                 <div class="card-image-preview hex-card-shape" id="editorImagePreviewContainer" style="width:120px; height:138px; margin-top:var(--spacing-unit); background-color: var(--bg-content-light); border:1px solid var(--border)">
                                    <img id="editorImagePreview" src="#" alt="Selected image preview" style="display:none; width:100%; height:100%; object-fit:cover;">
                                    <span id="editorImagePlaceholder" class="card-image-preview--empty" style="font-size:0.8rem; padding: var(--spacing-unit)">No Image Selected</span>
                                </div>
                                <p id="cardImageError" class="error-message-text" aria-live="assertive"></p>
                            </div>
                            
                            <h3 class="section-title" style="font-size: 1.25rem; margin-bottom: var(--spacing-unit); border-bottom-width: 1px; padding-bottom: calc(var(--spacing-unit)*0.5);">Metadata Properties</h3>
                            <div id="metadataList" class="metadata-list" aria-live="polite" aria-relevant="additions removals">
                                <div class="metadata-item">
                                    <label for="metaKey0" class="hidden-visually">Property Name 0</label>
                                    <input type="text" id="metaKey0" class="form-control metadata-key" placeholder="Property Name" value="Type" aria-describedby="metaKeyError0">
                                    <label for="metaValue0" class="hidden-visually">Property Value 0</label>
                                    <input type="text" id="metaValue0" class="form-control metadata-value" placeholder="Property Value" value="Artifact" aria-describedby="metaValueError0">
                                    <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove Type property">&times;</button>
                                    <p id="metaKeyError0" class="error-message-text metadata-error" style="grid-column: 1;"></p>
                                    <p id="metaValueError0" class="error-message-text metadata-error" style="grid-column: 2;"></p>
                                </div>
                                <div class="metadata-item">
                                     <label for="metaKey1" class="hidden-visually">Property Name 1</label>
                                    <input type="text" id="metaKey1" class="form-control metadata-key" placeholder="Property Name" value="Rarity">
                                     <label for="metaValue1" class="hidden-visually">Property Value 1</label>
                                    <input type="text" id="metaValue1" class="form-control metadata-value" placeholder="Property Value" value="Rare">
                                    <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove Rarity property">&times;</button>
                                </div>
                                <div class="metadata-item">
                                     <label for="metaKey2" class="hidden-visually">Property Name 2</label>
                                    <input type="text" id="metaKey2" class="form-control metadata-key" placeholder="Property Name" value="Effect">
                                     <label for="metaValue2" class="hidden-visually">Property Value 2</label>
                                    <input type="text" id="metaValue2" class="form-control metadata-value" placeholder="Property Value" value="Grants +2 to wisdom checks">
                                    <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove Effect property">&times;</button>
                                </div>
                                 <div class="metadata-item">
                                     <label for="metaKey3" class="hidden-visually">Property Name 3</label>
                                    <input type="text" id="metaKey3" class="form-control metadata-key" placeholder="Property Name" value="Creator">
                                     <label for="metaValue3" class="hidden-visually">Property Value 3</label>
                                    <input type="text" id="metaValue3" class="form-control metadata-value" placeholder="Property Value" value="Mage Council">
                                    <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove Creator property">&times;</button>
                                </div>
                            </div>
                            <div class="add-metadata-btn-container">
                                <button type="button" id="addMetadataBtn" class="btn btn-neutral">Add Property</button>
                            </div>
                             <div class="action-buttons" style="margin-top: calc(var(--spacing-unit)*3);">
                                <button type="button" class="btn btn-secondary" id="saveCardBtn">Save Card</button>
                                <button type="button" class="btn btn-neutral" id="exportCardBtn">Export Card</button>
                                <button type="button" class="btn btn-neutral" id="clearFormBtn">Cancel / Clear</button>
                            </div>
                        </form>
                    </div>
                    <div class="preview-section">
                        <h2 class="section-title">Card Preview</h2>
                        <div class="card-preview-wrapper">
                            <div id="liveCardPreview" class="card-preview-display hex-card-shape">
                                <div class="card-image-preview" id="previewImageContainer">
                                    <img id="previewImage" src="#" alt="Card image preview" style="display:none;">
                                    <span id="previewImagePlaceholder" class="card-image-preview--empty">Card Image Area</span>
                                </div>
                                <h3 id="previewTitle" class="card-title-preview">Arcane Hexstone</h3>
                                <div id="previewMetadata" class="card-metadata-preview">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="visage-shaper" class="screen content-screen-padding">
            <div class="container">
                <div class="visage-container">
                    <div class="cropping-section">
                        <h2 class="section-title">Shape the Visage</h2>
                        <div class="cropping-area" id="croppingAreaContainer">
                            <img id="imageToCrop" src="https://placehold.co/600x450/2C2C44/B0B0B0?text=Upload+Image+to+Crop" alt="Image to crop">
                            <div id="cropOverlay" class="crop-overlay hex-card-shape"></div>
                        </div>
                        <div class="cropping-controls">
                            <div class="control-group">
                                <label for="zoomSlider">Zoom:</label>
                                <input type="range" id="zoomSlider" class="form-control" min="50" max="200" value="100">
                            </div>
                            </div>
                    </div>
                    <div class="result-section">
                        <h2 class="section-title">Shaped Preview</h2>
                        <div class="result-preview-container hex-card-shape" id="cropResultPreview">
                            </div>
                        <div class="action-buttons">
                           <button type="button" class="btn btn-secondary" id="applyCropBtn">Apply Shape</button>
                           <button type="button" class="btn btn--neutral" data-screen-link="scriptorium">Back to Editor</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="obsidian-library" class="screen">
             <div class="library-layout">
                <aside class="sidebar" role="complementary">
                    <h2>Library Filters</h2>
                    <ul class="sidebar-menu">
                        <li><a href="#" class="active-sidebar-link" aria-current="true">All Cards</a></li>
                        <li><a href="#">By Type</a></li>
                        <li><a href="#">By Rarity</a></li>
                        <li><a href="#">Recently Added</a></li>
                    </ul>
                </aside>
                <div class="library-content content-screen-padding">
                    <h2>The Obsidian Library</h2>
                    <div class="toolbar">
                        <div class="search-bar">
                            <label for="librarySearchInput" class="hidden-visually">Search Cards</label>
                            <input type="search" id="librarySearchInput" placeholder="Search relics by name or lore...">
                            <button class="btn" aria-label="Search"><i class="fas fa-search"></i></button>
                        </div>
                        <div class="filter-options">
                            <button class="btn btn-neutral">Sort By: Name</button>
                            <button class="btn btn-neutral">View: Grid</button>
                        </div>
                    </div>
                    <div id="cardGrid" class="card-grid">
                        <div class="card-item hex-card-shape" tabindex="0" aria-label="Card: Dragon's Breath, Type: Fire">
                            <div class="card-thumbnail"><img src="https://placehold.co/150x100/4A0072/DAA520?text=DB" alt="Dragon's Breath"></div>
                            <div class="card-info"><h4>Dragon's Breath</h4><p>Fire Type</p></div>
                        </div>
                        <div class="card-item hex-card-shape" tabindex="0" aria-label="Card: Forest Spirit, Type: Nature">
                            <div class="card-thumbnail"><img src="https://placehold.co/150x100/3A005A/DAA520?text=FS" alt="Forest Spirit"></div>
                            <div class="card-info"><h4>Forest Spirit</h4><p>Nature Type</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="collection-forge" class="screen content-screen-padding">
            <div class="container">
                 <div class="forge-container">
                    <div class="card-selection">
                        <h2 class="section-title">Select Cards for Pack</h2>
                        <div class="toolbar" style="background-color: transparent; padding: 0 0 20px 0;">
                             <div class="search-bar" style="max-width:100%;">
                                <label for="packCardSearch" class="hidden-visually">Search cards for pack</label>
                                <input type="search" id="packCardSearch" placeholder="Filter cards...">
                                <button class="btn" aria-label="Search Cards"><i class="fas fa-filter"></i></button>
                            </div>
                        </div>
                        <div id="packCardList" class="card-list">
                            <div class="card-list-item" tabindex="0">
                                <div class="list-thumbnail hex-card-shape"><img src="https://placehold.co/60x69/4A0072/DAA520?text=DB" alt="Dragon's Breath"></div>
                                <div class="list-item-info"><h4>Dragon's Breath</h4><p>Fire Type, Common</p></div>
                                <input type="checkbox" class="list-checkbox" aria-label="Select Dragon's Breath">
                            </div>
                        </div>
                    </div>
                    <div class="pack-details">
                        <h2 class="section-title">Pack Details</h2>
                        <form id="packForm" class="pack-form">
                            <div class="form-group">
                                <label for="packName">Pack Name</label>
                                <input type="text" id="packName" class="form-control" placeholder="Genesis Starter Pack">
                            </div>
                            <div class="form-group">
                                <label for="packDescription">Description</label>
                                <textarea id="packDescription" class="form-control" rows="4" placeholder="Contains foundational cards..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="packIconUpload">Pack Icon (Optional)</label>
                                <input type="file" id="packIconUpload" class="form-control" accept="image/*">
                                <div class="pack-preview" id="packIconPreview">Pack Icon Preview</div>
                            </div>
                            <div class="action-buttons" style="justify-content: flex-start;">
                                <button type="button" class="btn btn-secondary">Create & Export Pack</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const navLinks = document.querySelectorAll('nav a.nav-link');
    const screenLinks = document.querySelectorAll('[data-screen-link]');
    const screens = document.querySelectorAll('.screen');
    const header = document.querySelector('header');
    let headerHeight = header ? header.offsetHeight : 60;

    // Update headerHeight if window resizes (e.g. devtools open/close)
    window.addEventListener('resize', () => {
        headerHeight = header ? header.offsetHeight : 60;
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
            activeScreen.style.paddingTop = headerHeight + 'px';
        }
    });


    function showScreen(screenId) {
        screens.forEach(screen => {
            if (screen.id === screenId) {
                screen.classList.add('active');
                screen.style.paddingTop = headerHeight + 'px';
                screen.setAttribute('tabindex', '-1'); 
                screen.focus();
            } else {
                screen.classList.remove('active');
                screen.removeAttribute('tabindex');
            }
        });
        navLinks.forEach(link => {
            link.classList.toggle('active-nav-link', link.dataset.screen === screenId);
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const screenId = link.dataset.screen;
            showScreen(screenId);
        });
    });
    
    screenLinks.forEach(link => {
         link.addEventListener('click', (e) => {
            e.preventDefault();
            const screenId = link.dataset.screenLink;
            showScreen(screenId);
        });
    });

    // --- Scriptorium (Card Editor) Logic ---
    const cardTitleInput = document.getElementById('cardTitle');
    const previewTitle = document.getElementById('previewTitle');
    const metadataList = document.getElementById('metadataList');
    const addMetadataBtn = document.getElementById('addMetadataBtn');
    const previewMetadata = document.getElementById('previewMetadata');
    const cardImageUpload = document.getElementById('cardImageUpload');
    const editorImagePreview = document.getElementById('editorImagePreview');
    const editorImagePlaceholder = document.getElementById('editorImagePlaceholder');
    const previewImage = document.getElementById('previewImage');
    const previewImagePlaceholder = document.getElementById('previewImagePlaceholder');
    const saveCardBtn = document.getElementById('saveCardBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const exportCardBtn = document.getElementById('exportCardBtn'); // Added export button

    const cardTitleErrorEl = document.getElementById('cardTitleError');
    const cardImageErrorEl = document.getElementById('cardImageError');


    function validateAndPreview() {
        let isValid = true;
        // Validate and Update title
        if (cardTitleInput.value.trim() === '') {
            cardTitleErrorEl.textContent = 'Card title cannot be empty.';
            cardTitleInput.classList.add('input-error');
            isValid = false;
        } else {
            cardTitleErrorEl.textContent = '';
            cardTitleInput.classList.remove('input-error');
        }
        previewTitle.textContent = cardTitleInput.value.trim() || 'Arcane Hexstone'; // Default if empty

        // Update metadata
        previewMetadata.innerHTML = '';
        const items = metadataList.querySelectorAll('.metadata-item');
        items.forEach((item, index) => {
            const keyInput = item.querySelector('.metadata-key');
            const valueInput = item.querySelector('.metadata-value');
            const keyErrorEl = item.querySelector(`#metaKeyError${index}`); // Assuming you'd add these
            
            const key = keyInput.value.trim();
            const value = valueInput.value.trim();

            if (key === '' && value !== '') {
                if(keyErrorEl) keyErrorEl.textContent = 'Property name required if value exists.';
                keyInput.classList.add('input-error');
                isValid = false;
            } else {
                 if(keyErrorEl) keyErrorEl.textContent = '';
                keyInput.classList.remove('input-error');
            }

            if (key) {
                const div = document.createElement('div');
                div.className = 'card-metadata-item-preview';
                div.innerHTML = `<span>${key}</span><span>${value || 'N/A'}</span>`;
                previewMetadata.appendChild(div);
            }
        });
        return isValid;
    }
    
    // Initial sample data population for preview
    function populateInitialPreview() {
        previewTitle.textContent = "Arcane Hexstone";
        previewMetadata.innerHTML = `
            <div class="card-metadata-item-preview"><span>Type</span><span>Artifact</span></div>
            <div class="card-metadata-item-preview"><span>Rarity</span><span>Rare</span></div>
            <div class="card-metadata-item-preview"><span>Effect</span><span>Grants +2 to wisdom checks</span></div>
            <div class="card-metadata-item-preview"><span>Creator</span><span>Mage Council</span></div>
        `;
    }


    if (cardTitleInput) cardTitleInput.addEventListener('input', validateAndPreview);
    if (metadataList) metadataList.addEventListener('input', validateAndPreview); // Update on any input in list

    if (addMetadataBtn) {
        addMetadataBtn.addEventListener('click', () => {
            const itemCount = metadataList.children.length;
            const newItem = document.createElement('div');
            newItem.className = 'metadata-item';
            newItem.innerHTML = `
                <label for="metaKey${itemCount}" class="hidden-visually">Property Name ${itemCount +1}</label>
                <input type="text" id="metaKey${itemCount}" class="form-control metadata-key" placeholder="Property Name" aria-describedby="metaKeyError${itemCount}">
                <label for="metaValue${itemCount}" class="hidden-visually">Property Value ${itemCount + 1}</label>
                <input type="text" id="metaValue${itemCount}" class="form-control metadata-value" placeholder="Property Value" aria-describedby="metaValueError${itemCount}">
                <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove this property">&times;</button>
                <p id="metaKeyError${itemCount}" class="error-message-text metadata-error" style="grid-column: 1;"></p>
                <p id="metaValueError${itemCount}" class="error-message-text metadata-error" style="grid-column: 2;"></p>
            `;
            metadataList.appendChild(newItem);
            newItem.querySelector('.remove-metadata-btn').addEventListener('click', function() {
                this.parentElement.remove();
                validateAndPreview();
            });
            newItem.querySelector('.metadata-key').focus();
        });
    }
    
    metadataList.querySelectorAll('.remove-metadata-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.parentElement.remove();
            validateAndPreview();
        });
    });


    if (cardImageUpload) {
        cardImageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            // Add some visual cue for dragover if desired
        });
        cardImageUpload.addEventListener('drop', (e) => { // Basic drop handling for file input
            e.preventDefault();
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                cardImageUpload.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true }); // Trigger change event
                cardImageUpload.dispatchEvent(event);
            }
        });
        cardImageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Basic file type validation
                if (!file.type.startsWith('image/')){
                    if(cardImageErrorEl) cardImageErrorEl.textContent = "Invalid file type. Please select an image.";
                    cardImageUpload.classList.add('input-error');
                    return;
                }
                // Basic file size validation (e.g., 5MB)
                if (file.size > 5 * 1024 * 1024) {
                     if(cardImageErrorEl) cardImageErrorEl.textContent = "File too large. Maximum 5MB.";
                     cardImageUpload.classList.add('input-error');
                    return;
                }
                if(cardImageErrorEl) cardImageErrorEl.textContent = "";
                cardImageUpload.classList.remove('input-error');

                const reader = new FileReader();
                reader.onload = function(event) {
                    editorImagePreview.src = event.target.result;
                    editorImagePreview.style.display = 'block';
                    editorImagePlaceholder.style.display = 'none';
                    
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    previewImagePlaceholder.style.display = 'none';

                    const imageToCrop = document.getElementById('imageToCrop');
                    if (imageToCrop) imageToCrop.src = event.target.result;
                    updateCropResultPreview(); 
                }
                reader.readAsDataURL(file);
            } else { // No file selected
                editorImagePreview.src = '#';
                editorImagePreview.style.display = 'none';
                editorImagePlaceholder.style.display = 'block';
                previewImage.src = '#';
                previewImage.style.display = 'none';
                previewImagePlaceholder.style.display = 'block';
                if(cardImageErrorEl) cardImageErrorEl.textContent = "";
                cardImageUpload.classList.remove('input-error');
            }
        });
    }
    
    if (clearFormBtn) {
        clearFormBtn.addEventListener('click', () => {
            document.getElementById('cardForm').reset();
            // Clear dynamic metadata, preserving one empty row for new input
            metadataList.innerHTML = `
                <div class="metadata-item">
                    <label for="metaKeyNew" class="hidden-visually">Property Name New</label>
                    <input type="text" id="metaKeyNew" class="form-control metadata-key" placeholder="Property Name">
                    <label for="metaValueNew" class="hidden-visually">Property Value New</label>
                    <input type="text" id="metaValueNew" class="form-control metadata-value" placeholder="Property Value">
                    <button type="button" class="btn btn--danger btn--icon remove-metadata-btn" aria-label="Remove this property">&times;</button>
                     <p id="metaKeyErrorNew" class="error-message-text metadata-error" style="grid-column: 1;"></p>
                </div>`;
            metadataList.querySelector('.remove-metadata-btn').addEventListener('click', function() {
                this.parentElement.remove();
                validateAndPreview();
            });

            editorImagePreview.src = '#';
            editorImagePreview.style.display = 'none';
            editorImagePlaceholder.style.display = 'block';
            previewImage.src = '#';
            previewImage.style.display = 'none';
            previewImagePlaceholder.style.display = 'block';
            const imageToCrop = document.getElementById('imageToCrop');
            if (imageToCrop) imageToCrop.src = 'https://placehold.co/600x450/2C2C44/B0B0B0?text=Upload+Image+to+Crop';
            
            // Reset errors
            if(cardTitleErrorEl) cardTitleErrorEl.textContent = "";
            cardTitleInput.classList.remove('input-error');
            if(cardImageErrorEl) cardImageErrorEl.textContent = "";
            cardImageUpload.classList.remove('input-error');

            populateInitialPreview(); // Reset preview to sample data
            updateCropResultPreview();
        });
    }

    if(saveCardBtn) {
        saveCardBtn.addEventListener('click', () => {
            if (validateAndPreview()) { // validateAndPreview now returns true if valid
                console.log("Card Saved (Conceptual):", {
                    title: cardTitleInput.value,
                    metadata: Array.from(metadataList.querySelectorAll('.metadata-item')).map(item => ({
                        key: item.querySelector('.metadata-key').value,
                        value: item.querySelector('.metadata-value').value
                    })).filter(m => m.key.trim() !== '') // Only save items with a key
                });
                alert("Card 'Sealed' (data logged to console).");
            } else {
                alert("Please correct the errors highlighted in the form.");
            }
        });
    }
    if(exportCardBtn){
        exportCardBtn.addEventListener('click', () => {
            alert("Export Card functionality to be implemented.");
        });
    }


    // --- Visage Shaper (Image Cropper) Logic ---
    const croppingAreaContainer = document.getElementById('croppingAreaContainer');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropOverlay = document.getElementById('cropOverlay');
    const zoomSlider = document.getElementById('zoomSlider');
    const cropResultPreview = document.getElementById('cropResultPreview');
    const applyCropBtn = document.getElementById('applyCropBtn');

    let isDragging = false;
    let startX, startY, initialOverlayX, initialOverlayY;
    let currentZoom = 1;
    let imageOriginalWidth, imageOriginalHeight;

    if (imageToCrop) {
        imageToCrop.onload = () => {
            imageOriginalWidth = imageToCrop.naturalWidth;
            imageOriginalHeight = imageToCrop.naturalHeight;
            currentZoom = 1;
            if(zoomSlider) zoomSlider.value = 100;
            imageToCrop.style.transform = `scale(1) translate(0,0)`; // Reset transform
            imageToCrop.style.left = '0px'; // Reset direct positioning
            imageToCrop.style.top = '0px';

            if(cropOverlay && croppingAreaContainer) {
                const containerWidth = croppingAreaContainer.offsetWidth;
                const containerHeight = croppingAreaContainer.offsetHeight;
                // Set overlay size based on image or container, ensure it's not too big
                let overlayWidth = Math.min(containerWidth, imageOriginalWidth * currentZoom) * 0.6;
                let overlayHeight = overlayWidth * 1.15; // Maintain aspect ratio

                if (overlayHeight > containerHeight * 0.9) {
                    overlayHeight = containerHeight * 0.9;
                    overlayWidth = overlayHeight / 1.15;
                }
                 if (overlayWidth > containerWidth * 0.9) {
                    overlayWidth = containerWidth * 0.9;
                    overlayHeight = overlayWidth * 1.15;
                }

                cropOverlay.style.width = `${overlayWidth}px`;
                cropOverlay.style.height = `${overlayHeight}px`;
                cropOverlay.style.left = `${(containerWidth - overlayWidth) / 2}px`;
                cropOverlay.style.top = `${(containerHeight - overlayHeight) / 2}px`;
            }
            updateCropResultPreview();
        };
        if (imageToCrop.complete && imageToCrop.naturalWidth > 0) {
            imageToCrop.onload();
        }
    }

    if (cropOverlay && croppingAreaContainer) {
        cropOverlay.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialOverlayX = cropOverlay.offsetLeft;
            initialOverlayY = cropOverlay.offsetTop;
            cropOverlay.style.cursor = 'grabbing';
            e.preventDefault(); 
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            let newX = initialOverlayX + dx;
            let newY = initialOverlayY + dy;

            const maxX = croppingAreaContainer.offsetWidth - cropOverlay.offsetWidth;
            const maxY = croppingAreaContainer.offsetHeight - cropOverlay.offsetHeight;
            
            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));

            cropOverlay.style.left = `${newX}px`;
            cropOverlay.style.top = `${newY}px`;
            updateCropResultPreview();
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                cropOverlay.style.cursor = 'move';
            }
        });
    }

    if (zoomSlider && imageToCrop) {
        zoomSlider.addEventListener('input', () => {
            currentZoom = parseFloat(zoomSlider.value) / 100;
            // We scale the image, not the overlay for this zoom type
            imageToCrop.style.transformOrigin = 'center center'; 
            imageToCrop.style.transform = `scale(${currentZoom})`;
            // Recalculate overlay position if needed, or adjust boundaries for dragging
            updateCropResultPreview();
        });
    }

    function updateCropResultPreview() {
        if (!imageToCrop || !cropOverlay || !cropResultPreview || !imageToCrop.complete || imageToCrop.naturalWidth === 0) return;

        const imgContainerRect = croppingAreaContainer.getBoundingClientRect();
        const imgCurrentRect = imageToCrop.getBoundingClientRect(); // This rect is of the transformed image
        const overlayRect = cropOverlay.getBoundingClientRect();

        // Position of overlay relative to the container
        const overlayXInContainer = overlayRect.left - imgContainerRect.left;
        const overlayYInContainer = overlayRect.top - imgContainerRect.top;

        // Position of image relative to the container
        const imgXInContainer = imgCurrentRect.left - imgContainerRect.left;
        const imgYInContainer = imgCurrentRect.top - imgContainerRect.top;
        
        // Calculate the part of the *original, unscaled* image that the overlay covers
        const cropX = (overlayXInContainer - imgXInContainer) / currentZoom;
        const cropY = (overlayYInContainer - imgYInContainer) / currentZoom;
        const cropWidth = overlayRect.width / currentZoom;
        const cropHeight = overlayRect.height / currentZoom;

        cropResultPreview.style.backgroundImage = `url('${imageToCrop.src}')`;
        
        const previewContainerWidth = cropResultPreview.offsetWidth;
        // Calculate scale factor to fit the cropped section into the preview container
        const scaleFactor = previewContainerWidth / cropWidth;

        cropResultPreview.style.backgroundSize = `${imageOriginalWidth * scaleFactor}px ${imageOriginalHeight * scaleFactor}px`;
        cropResultPreview.style.backgroundPosition = `-${cropX * scaleFactor}px -${cropY * scaleFactor}px`;
    }
    
    if(applyCropBtn) {
        applyCropBtn.addEventListener('click', () => {
            if (previewImage && cropResultPreview.style.backgroundImage && imageToCrop.src !== '#' && !imageToCrop.src.includes('placehold.co')) {
                // This is where you'd ideally generate a new cropped image Data URL using a canvas
                // For this prototype, we'll try to apply the background as best as possible to the Scriptorium preview
                previewImage.src = imageToCrop.src; // Set the source
                previewImage.style.display = 'block';
                previewImagePlaceholder.style.display = 'none';

                // The challenge is applying the 'crop' to an <img> tag using only CSS background properties.
                // It's better to use a div with background for the previewImage in Scriptorium if we want to replicate this accurately.
                // For now, this is a conceptual "application"
                const previewImageContainer = document.getElementById('previewImageContainer');
                if (previewImageContainer) {
                    previewImageContainer.classList.add('hex-card-shape'); // Ensure it's hex
                    previewImageContainer.style.backgroundImage = cropResultPreview.style.backgroundImage;
                    previewImageContainer.style.backgroundSize = cropResultPreview.style.backgroundSize;
                    previewImageContainer.style.backgroundPosition = cropResultPreview.style.backgroundPosition;
                    previewImage.style.display = 'none'; // Hide the actual img tag if using background on container
                    previewImagePlaceholder.style.display = 'none';
                }
                
                // Also update the small editor preview
                if (editorImagePreviewContainer) {
                    editorImagePreviewContainer.classList.add('hex-card-shape');
                    editorImagePreviewContainer.style.backgroundImage = cropResultPreview.style.backgroundImage;
                    editorImagePreviewContainer.style.backgroundSize = cropResultPreview.style.backgroundSize;
                    editorImagePreviewContainer.style.backgroundPosition = cropResultPreview.style.backgroundPosition;
                    editorImagePreview.style.display = 'none';
                    editorImagePlaceholder.style.display = 'none';
                }


                alert("Crop applied to Scriptorium preview (using background properties).");
            } else {
                alert("No image or crop data to apply.");
            }
            showScreen('scriptorium'); 
        });
    }

    // --- Obsidian Library (Placeholder population) ---
    const cardGrid = document.getElementById('cardGrid');
    if (cardGrid) {
        const sampleCards = [
            { title: "Shadow Weaver", type: "Dark", imgSrc: "https://placehold.co/150x172/2C2C44/DAA520?text=SW&font=Inter" }, // Adjusted for hex ratio
            { title: "Sunstone Golem", type: "Earth", imgSrc: "https://placehold.co/150x172/5C4077/DAA520?text=SG&font=Inter" },
            { title: "Tidal Serpent", type: "Water", imgSrc: "https://placehold.co/150x172/404058/DAA520?text=TS&font=Inter" },
            { title: "Sky Sentinel", type: "Air", imgSrc: "https://placehold.co/150x172/1A1A2E/DAA520?text=SS&font=Inter" }
        ];
        while (cardGrid.children.length > 2) { cardGrid.removeChild(cardGrid.lastChild); } // Clear existing beyond initial
        sampleCards.forEach(card => {
            const cardItem = document.createElement('div');
            cardItem.className = 'card-item hex-card-shape';
            cardItem.tabIndex = 0;
            cardItem.setAttribute('aria-label', `Card: ${card.title}, Type: ${card.type}`);
            cardItem.innerHTML = `
                <div class="card-thumbnail hex-card-shape"><img src="${card.imgSrc}" alt="${card.title}"></div>
                <div class="card-info"><h4>${card.title}</h4><p>${card.type} Type</p></div>
            `;
            cardGrid.appendChild(cardItem);
        });
    }

    // --- Collection Forge (Placeholder population) ---
    const packCardList = document.getElementById('packCardList');
    if (packCardList) {
         const samplePackCards = [
            { title: "Ancient Tome", type: "Arcane", rarity: "Rare", imgSrc: "https://placehold.co/60x69/2C2C44/DAA520?text=AT&font=Inter" },
            { title: "Griffin Feather", type: "Air", rarity: "Uncommon", imgSrc: "https://placehold.co/60x69/5C4077/DAA520?text=GF&font=Inter" },
        ];
        while (packCardList.children.length > 1) { packCardList.removeChild(packCardList.lastChild); }
        samplePackCards.forEach(card => {
            const listItem = document.createElement('div');
            listItem.className = 'card-list-item';
            listItem.tabIndex = 0;
            listItem.innerHTML = `
                <div class="list-thumbnail hex-card-shape"><img src="${card.imgSrc}" alt="${card.title}"></div>
                <div class="list-item-info"><h4>${card.title}</h4><p>${card.type} Type, ${card.rarity}</p></div>
                <input type="checkbox" class="list-checkbox" aria-label="Select ${card.title}">
            `;
            packCardList.appendChild(listItem);
        });
    }
    
    // Initial UI updates
    populateInitialPreview(); // Populate Scriptorium preview with sample data
    if (imageToCrop && imageToCrop.complete && imageToCrop.naturalWidth > 0) {
         updateCropResultPreview();
    }

    // Set Scriptorium as default active screen
    showScreen('scriptorium'); 

});
</script>
</body>
</html>
